// === CONFIGURACI칍N DE PINES ===
#define PIN_TRIG 7
#define PIN_ECHO 6

// === CONFIGURACI칍N DE RANGOS Y TIEMPOS ===
#define DISTANCIA_MIN 10          // cm m칤nimos para detectar
#define DISTANCIA_MAX 50          // cm m치ximos para detectar
#define INTERVALO_MEDICION 100    // ms entre mediciones
#define INTERVALO_REPORTE 2000    // ms entre reportes por Serial
#define TIMEOUT_ECHO 30000        // timeout en microsegundos

// === MACROS ===
#define MICROS_A_CM(duracion) ((duracion) * 0.034 / 2)
#define EN_RANGO(dist) ((dist) >= DISTANCIA_MIN && (dist) <= DISTANCIA_MAX)

// === VARIABLES EST츼TICAS ===
static uint8_t estadoSensor = 0;
static unsigned long tiempoInicioMicros = 0;
static unsigned long tiempoUltimaMedicion = 0;
static unsigned long tiempoUltimoReporte = 0;
static int obstaculosDetectados = 0;

// === FUNCI칍N PRINCIPAL DEL ULTRAS칍NICO ===
void actualizarUltrasonico() {
  static long distancia = 0;
  unsigned long ahora = millis();
  unsigned long ahoraMicros = micros();
  
  // M치quina de estados para medici칩n no bloqueante
  switch (estadoSensor) {
    case 0: // ESPERANDO - Iniciar nueva medici칩n
      if (ahora - tiempoUltimaMedicion >= INTERVALO_MEDICION) {
        tiempoUltimaMedicion = ahora;
        digitalWrite(PIN_TRIG, LOW);
        tiempoInicioMicros = ahoraMicros;
        estadoSensor = 1;
      }
      break;
      
    case 1: // TRIGGER LOW (2췃s)
      if (ahoraMicros - tiempoInicioMicros >= 2) {
        digitalWrite(PIN_TRIG, HIGH);
        tiempoInicioMicros = ahoraMicros;
        estadoSensor = 2;
      }
      break;
      
    case 2: // TRIGGER HIGH (10췃s)
      if (ahoraMicros - tiempoInicioMicros >= 10) {
        digitalWrite(PIN_TRIG, LOW);
        tiempoInicioMicros = ahoraMicros;
        estadoSensor = 3;
      }
      break;
      
    case 3: // ESPERANDO ECHO HIGH
      if (digitalRead(PIN_ECHO) == HIGH) {
        tiempoInicioMicros = ahoraMicros;
        estadoSensor = 4;
      } else if (ahoraMicros - tiempoInicioMicros >= TIMEOUT_ECHO) {
        estadoSensor = 0; // Timeout, reiniciar
      }
      break;
      
    case 4: // MIDIENDO ECHO
      if (digitalRead(PIN_ECHO) == LOW) {
        unsigned long duracion = ahoraMicros - tiempoInicioMicros;
        distancia = MICROS_A_CM(duracion);
        
        // Contar si est치 en rango
        if (EN_RANGO(distancia)) {
          obstaculosDetectados++;
        }
        
        estadoSensor = 0; // Listo para siguiente medici칩n
      } else if (ahoraMicros - tiempoInicioMicros >= TIMEOUT_ECHO) {
        estadoSensor = 0; // Timeout
      }
      break;
  }
  
  // Reporte peri칩dico por Serial
  if (ahora - tiempoUltimoReporte >= INTERVALO_REPORTE) {
    tiempoUltimoReporte = ahora;
    
    Serial.print("[Ultras칩nico] Obst치culos detectados (");
    Serial.print(DISTANCIA_MIN);
    Serial.print("-");
    Serial.print(DISTANCIA_MAX);
    Serial.print(" cm): ");
    Serial.println(obstaculosDetectados);
    
    obstaculosDetectados = 0; // Resetear contador
  }
}

// === SETUP ===
void setup() {
  Serial.begin(9600);
  pinMode(PIN_TRIG, OUTPUT);
  pinMode(PIN_ECHO, INPUT);
  digitalWrite(PIN_TRIG, LOW);
  
  Serial.println("=== SENSOR ULTRAS칍NICO INICIADO ===");
  Serial.print("Rango de detecci칩n: ");
  Serial.print(DISTANCIA_MIN);
  Serial.print(" - ");
  Serial.print(DISTANCIA_MAX);
  Serial.println(" cm");
}

// === LOOP PRINCIPAL ===
void loop() {
  actualizarUltrasonico(); // Solo llamar esta funci칩n en el loop
}

----------------------------------------------------------------------------

 Funcionalidades:

_Detecta obst치culos entre 10-50 cm (configurable con macros)
_Cuenta cu치ntos obst치culos detecta en el rango definido
_Reporta cada 2 segundos por Serial el total de detecciones
_100% no bloqueante usando millis() y micros()
_M치quina de estados compacta dentro de la misma funci칩n

游꿢 Configuraci칩n r치pida:

#define DISTANCIA_MIN 10          // Ajustar m칤nimo
#define DISTANCIA_MAX 50          // Ajustar m치ximo
#define INTERVALO_REPORTE 2000    // Cambiar frecuencia de reporte
```

## 游늵 Salida Serial:
```
[Ultras칩nico] Obst치culos detectados (10-50 cm): 15
[Ultras칩nico] Obst치culos detectados (10-50 cm): 12

Simplemente llama actualizarUltrasonico() en el loop junto con tu funci칩n del servo